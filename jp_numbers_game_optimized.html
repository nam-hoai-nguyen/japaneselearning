<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JP Numbers Game (Romaji/Hiragana/Katakana)</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#121a33;--panel-2:#0f1630;--acc:#6ee7ff;--acc-2:#9ef0a4;--danger:#ff6b6b;--warn:#ffd166;--muted:#9aa3b2;--text:#e9f0ff;
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial; background:linear-gradient(180deg,var(--bg),#050912);color:var(--text)}
    .container{max-width:1500px;margin-inline:auto;padding:20px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .badge{background:linear-gradient(135deg,var(--acc),#8bbfff);color:#00131a;font-weight:800;padding:6px 10px;border-radius:10px}
    .title{font-weight:800;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:13px}

    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);box-shadow:0 8px 30px rgba(20,30,60,.35);border-radius:18px;padding:16px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media(max-width: 960px){ .grid{grid-template-columns:1fr;}} 

    .controls{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;align-items:end}
    @media(max-width: 900px){ .controls{grid-template-columns:repeat(3,minmax(0,1fr));}}
    @media(max-width: 640px){ .controls{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width: 420px){ .controls{grid-template-columns:1fr;}}
    .controls label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;font-weight:500}
    
    select,button,input[type="number"],input[type="text"],input[type="range"]{
      background:#0e1430;
      border:1px solid rgba(255,255,255,.1);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
      outline:none;
      width:100%;
      box-sizing:border-box;
    }
    
    select:focus,button:focus,input:focus{border-color:var(--acc)}
    .btn{cursor:pointer;transition:transform .05s ease, background .2s;font-weight:600}
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn.primary{background:linear-gradient(180deg,#1b2b6d,#15326f);border-color:#284a9d}
    .btn.success{background:linear-gradient(180deg,#114d33,#0d3b27);border-color:#1d7a53}
    .btn.ghost{background:#0f1630}

    .stats{display:flex;flex-wrap:wrap;gap:10px}
    .chip{background:#0e1533;border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:12px;font-size:13px}

    .prompt{display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;text-align:center;padding:26px;border-radius:16px;background:#0d1430;border:1px solid rgba(255,255,255,.06);min-height:150px}
    .prompt .num{font-size:32px;font-weight:800;letter-spacing:.5px}
    .prompt .unit{font-size:12px;color:var(--muted)}

    .options{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
    @media(max-width:640px){ .options{grid-template-columns:1fr}}
    .option{background:#121a3d;border:1px solid rgba(255,255,255,.08);padding:14px;border-radius:12px;text-align:center;cursor:pointer;font-size:16px;transition:all .2s}
    .option:hover{border-color:var(--acc);background:#1a2550;transform:translateY(-1px)}

    .feedback{min-height:32px;font-size:14px;margin-top:10px;padding:8px;border-radius:8px}
    .ok{color:var(--acc-2)}
    .bad{color:var(--danger)}

    .progress{height:10px;background:#0a0f24;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--acc),#98f9ff);transition:width .3s ease}

    .section-title{margin:16px 0 8px 0;font-size:13px;color:var(--muted);letter-spacing:.3px;text-transform:uppercase;font-weight:600}

    .kbd{display:inline-block;background:#0b1026;border:1px solid rgba(255,255,255,.08);border-bottom-color:rgba(0,0,0,.4);padding:2px 6px;border-radius:6px;font-size:12px}

    footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
    .sr{position:absolute;left:-9999px}
    
    /* Style cho toggle button group */
    .toggle-group{
      display:flex;
      gap:0;
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      overflow:hidden;
      background:#0e1430;
      width:100%;
      box-sizing:border-box;
    }
    .toggle-btn{
      flex:1;
      padding:10px 8px;
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      transition:all .2s;
      font-size:13px;
      font-weight:500;
    }
    .toggle-btn:hover{background:rgba(255,255,255,.05)}
    .toggle-btn.active{background:var(--acc);color:#00131a;font-weight:700}
    
    /* Speed control section */
    .speed-wrapper{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .speed-control{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .speed-control input[type="range"]{
      flex:1;
      min-width:0;
    }
    .speed-value{
      min-width:50px;
      text-align:center;
      font-weight:600;
      color:var(--acc);
      font-size:13px;
      padding:4px 8px;
      background:rgba(110,231,255,0.1);
      border-radius:6px;
    }
    
    /* Grid spanning for better layout */
    .span-2{grid-column:span 2}
    
    @media(max-width: 900px){
      .span-2{grid-column:span 1}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="badge">Há»c sá»‘ Ä‘áº¿m tiáº¿ng nháº­t</div>
        <div>
          <div class="title">Cuá»™c PhiÃªu LÆ°u Cá»§a Nhá»¯ng Con Sá»‘ (Romaji/Hiragana/Katakana)</div>
          <div class="sub">Luyá»‡n Ä‘á»c sá»‘ tiáº¿ng Nháº­t tá»« 1 Ä‘áº¿n chou (nghÃ¬n tá»·) theo nhÃ³m 4 chá»¯ sá»‘</div>
        </div>
      </div>
      <div class="stats">
        <div class="chip">Äiá»ƒm: <b id="score">0</b></div>
        <div class="chip">ÄÃºng liÃªn tiáº¿p: <b id="streak">0</b></div>
        <div class="chip">Cáº¥p Ä‘á»™: <b id="levelLabel">Lv.1 Sen</b></div>
        <div class="chip">Cháº¿ Ä‘á»™: <b id="modeLabel">Äá»c sá»‘</b></div>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="section-title">Cáº¥u hÃ¬nh mÃ n chÆ¡i</div>
        <div class="controls">
          <!-- Row 1: Mode, Level, Questions -->
          <div>
            <label for="mode">Chá»n cháº¿ Ä‘á»™</label>
            <select id="mode">
              <option value="mc">ğŸ”¢ Äá»c sá»‘ (tráº¯c nghiá»‡m)</option>
              <option value="type">âœï¸ Nháº­p cÃ¡ch Ä‘á»c</option>
              <option value="listen">ğŸ‘‚ Nghe & gÃµ sá»‘</option>
            </select>
          </div>
          <div>
            <label for="level">Cáº¥p Ä‘á»™</label>
            <select id="level">
              <option value="sen">Lv.1 â€“ Sen (1â€“99,999)</option>
              <option value="man">Lv.2 â€“ Man (10,000â€“9,999,999)</option>
              <option value="oku">Lv.3 â€“ Oku (100Mâ€“99B)</option>
              <option value="chou">Lv.4 â€“ Chou (1Tâ€“9999T)</option>
            </select>
          </div>
          <div>
            <label for="limit">Sá»‘ cÃ¢u há»i</label>
            <input id="limit" type="number" min="5" max="50" step="1" value="10" />
          </div>
          <div>
            <label for="timer">Thá»i gian (giÃ¢y/cÃ¢u)</label>
            <select id="timer">
              <option value="0">KhÃ´ng giá»›i háº¡n</option>
              <option value="10">10 giÃ¢y</option>
              <option value="20" selected>20 giÃ¢y</option>
              <option value="30">30 giÃ¢y</option>
            </select>
          </div>
          <div>
            <label>Kiá»ƒu hiá»ƒn thá»‹</label>
            <div class="toggle-group">
              <button class="toggle-btn active" data-script="romaji">Romaji</button>
              <button class="toggle-btn" data-script="hiragana">ã²ã‚‰ãŒãª</button>
              <button class="toggle-btn" data-script="katakana">ã‚«ã‚¿ã‚«ãƒŠ</button>
            </div>
          </div>
          
          <!-- Row 2: Speed control and buttons -->
          <div class="span-2">
            <label for="rate">Tá»‘c Ä‘á»™ phÃ¡t Ã¢m (jaâ€‘JP TTS)</label>
            <div class="speed-control">
              <input id="rate" type="range" min="0.6" max="1.8" step="0.1" value="1.0"/>
              <span id="rateVal" class="speed-value">1.0Ã—</span>
            </div>
          </div>
          
          <div>
            <label>&nbsp;</label>
            <button id="start" class="btn primary">ğŸš€ Báº¯t Ä‘áº§u</button>
          </div>
          
          <div>
            <label>&nbsp;</label>
            <button id="speak" class="btn ghost" title="Äá»c phÃ¡t Ã¢m" disabled>ğŸ”ˆ PhÃ¡t Ã¢m</button>
          </div>
          
          <div>
            <label>&nbsp;</label>
            <button id="skip" class="btn ghost" disabled>â­ï¸ Bá» qua</button>
          </div>
        </div>

        <div style="margin-top:16px" class="progress"><div id="progressBar" class="bar"></div></div>

        <div class="section-title">CÃ¢u há»i</div>
        <div id="prompt" class="prompt" aria-live="polite">
          <div class="unit">â€” nháº¥n Báº¯t Ä‘áº§u Ä‘á»ƒ chÆ¡i â€”</div>
        </div>
        <div id="feedback" class="feedback"></div>
      </section>

      <aside class="panel">
        <div class="section-title">Ghi chÃº nhanh</div>
        <ul style="margin:0 0 10px 16px;line-height:1.7;font-size:14px">
          <li>Nháº­t dÃ¹ng Ä‘Æ¡n vá»‹ <b>man</b> (ä¸‡), <b>oku</b> (å„„), <b>chou</b> (å…†) theo nhÃ³m 4 chá»¯ sá»‘.</li>
          <li>Biáº¿n Ã¢m: 300 â†’ <b>sanbyaku</b> (ã•ã‚“ã³ã‚ƒã), 600 â†’ <b>roppyaku</b> (ã‚ã£ã´ã‚ƒã), 800 â†’ <b>happyaku</b> (ã¯ã£ã´ã‚ƒã)</li>
          <li>3000 â†’ <b>sanzen</b> (ã•ã‚“ãœã‚“), 8000 â†’ <b>hassen</b> (ã¯ã£ã›ã‚“)</li>
          <li>100 = <b>hyaku</b> (ã²ã‚ƒã), 1000 = <b>sen</b> (ã›ã‚“), 10 = <b>juu</b> (ã˜ã‚…ã†)</li>
          <li>10,000 = <b>ichi man</b> (ã„ã¡ã¾ã‚“); 100,000,000 = <b>ichi oku</b> (ã„ã¡ãŠã)</li>
        </ul>
        <div class="section-title">VÃ¬ sao cÃ³ tá»« "chou" á»Ÿ cuá»‘i?</div>
        <p style="margin:0;color:var(--muted);font-size:14px;line-height:1.6">
          Tiáº¿ng Nháº­t nhÃ³m sá»‘ theo khá»‘i 4 chá»¯ sá»‘. Má»—i khá»‘i cÃ³ má»™t tÃªn Ä‘Æ¡n vá»‹: (Ä‘Æ¡n vá»‹) â†’ man â†’ oku â†’ chou. 
          Khi Ä‘á»c sá»‘ lá»›n, ta Ä‘á»c pháº§n má»—i khá»‘i rá»“i <b>thÃªm tÃªn Ä‘Æ¡n vá»‹ phÃ­a sau</b>. 
          VÃ­ dá»¥: <span class="kbd">1,234,000,000,000</span> â†’ <i>sen ni hyaku san juu yon chou</i>.
        </p>

        <div class="section-title">Lá»‹ch sá»­</div>
        <div id="history" style="font-size:13px;color:var(--muted);max-height:300px;overflow:auto;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px;line-height:1.6"></div>
      </aside>
    </div>

    <footer>
      Â© 2025 Há»c sá»‘ Ä‘áº¿m tiáº¿ng Nháº­t â€“ Enhanced with Romaji/Hiragana/Katakana support.
    </footer>
  </div>

  <script>
    // ---------- Romaji to Hiragana/Katakana Conversion ----------
    const romajiToHiragana = {
      'a':'ã‚','i':'ã„','u':'ã†','e':'ãˆ','o':'ãŠ',
      'ka':'ã‹','ki':'ã','ku':'ã','ke':'ã‘','ko':'ã“',
      'ga':'ãŒ','gi':'ã','gu':'ã','ge':'ã’','go':'ã”',
      'sa':'ã•','shi':'ã—','su':'ã™','se':'ã›','so':'ã',
      'za':'ã–','ji':'ã˜','zu':'ãš','ze':'ãœ','zo':'ã',
      'ta':'ãŸ','chi':'ã¡','tsu':'ã¤','te':'ã¦','to':'ã¨',
      'da':'ã ','di':'ã¢','du':'ã¥','de':'ã§','do':'ã©',
      'na':'ãª','ni':'ã«','nu':'ã¬','ne':'ã­','no':'ã®',
      'ha':'ã¯','hi':'ã²','fu':'ãµ','he':'ã¸','ho':'ã»',
      'ba':'ã°','bi':'ã³','bu':'ã¶','be':'ã¹','bo':'ã¼',
      'pa':'ã±','pi':'ã´','pu':'ã·','pe':'ãº','po':'ã½',
      'ma':'ã¾','mi':'ã¿','mu':'ã‚€','me':'ã‚','mo':'ã‚‚',
      'ya':'ã‚„','yu':'ã‚†','yo':'ã‚ˆ',
      'ra':'ã‚‰','ri':'ã‚Š','ru':'ã‚‹','re':'ã‚Œ','ro':'ã‚',
      'wa':'ã‚','wo':'ã‚’','n':'ã‚“',
      'kya':'ãã‚ƒ','kyu':'ãã‚…','kyo':'ãã‚‡',
      'gya':'ãã‚ƒ','gyu':'ãã‚…','gyo':'ãã‚‡',
      'sha':'ã—ã‚ƒ','shu':'ã—ã‚…','sho':'ã—ã‚‡',
      'ja':'ã˜ã‚ƒ','ju':'ã˜ã‚…','jo':'ã˜ã‚‡',
      'cha':'ã¡ã‚ƒ','chu':'ã¡ã‚…','cho':'ã¡ã‚‡',
      'nya':'ã«ã‚ƒ','nyu':'ã«ã‚…','nyo':'ã«ã‚‡',
      'hya':'ã²ã‚ƒ','hyu':'ã²ã‚…','hyo':'ã²ã‚‡',
      'bya':'ã³ã‚ƒ','byu':'ã³ã‚…','byo':'ã³ã‚‡',
      'pya':'ã´ã‚ƒ','pyu':'ã´ã‚…','pyo':'ã´ã‚‡',
      'mya':'ã¿ã‚ƒ','myu':'ã¿ã‚…','myo':'ã¿ã‚‡',
      'rya':'ã‚Šã‚ƒ','ryu':'ã‚Šã‚…','ryo':'ã‚Šã‚‡',
    };

    const romajiToKatakana = {
      'a':'ã‚¢','i':'ã‚¤','u':'ã‚¦','e':'ã‚¨','o':'ã‚ª',
      'ka':'ã‚«','ki':'ã‚­','ku':'ã‚¯','ke':'ã‚±','ko':'ã‚³',
      'ga':'ã‚¬','gi':'ã‚®','gu':'ã‚°','ge':'ã‚²','go':'ã‚´',
      'sa':'ã‚µ','shi':'ã‚·','su':'ã‚¹','se':'ã‚»','so':'ã‚½',
      'za':'ã‚¶','ji':'ã‚¸','zu':'ã‚º','ze':'ã‚¼','zo':'ã‚¾',
      'ta':'ã‚¿','chi':'ãƒ','tsu':'ãƒ„','te':'ãƒ†','to':'ãƒˆ',
      'da':'ãƒ€','di':'ãƒ‚','du':'ãƒ…','de':'ãƒ‡','do':'ãƒ‰',
      'na':'ãƒŠ','ni':'ãƒ‹','nu':'ãƒŒ','ne':'ãƒ','no':'ãƒ',
      'ha':'ãƒ','hi':'ãƒ’','fu':'ãƒ•','he':'ãƒ˜','ho':'ãƒ›',
      'ba':'ãƒ','bi':'ãƒ“','bu':'ãƒ–','be':'ãƒ™','bo':'ãƒœ',
      'pa':'ãƒ‘','pi':'ãƒ”','pu':'ãƒ—','pe':'ãƒš','po':'ãƒ',
      'ma':'ãƒ','mi':'ãƒŸ','mu':'ãƒ ','me':'ãƒ¡','mo':'ãƒ¢',
      'ya':'ãƒ¤','yu':'ãƒ¦','yo':'ãƒ¨',
      'ra':'ãƒ©','ri':'ãƒª','ru':'ãƒ«','re':'ãƒ¬','ro':'ãƒ­',
      'wa':'ãƒ¯','wo':'ãƒ²','n':'ãƒ³',
      'kya':'ã‚­ãƒ£','kyu':'ã‚­ãƒ¥','kyo':'ã‚­ãƒ§',
      'gya':'ã‚®ãƒ£','gyu':'ã‚®ãƒ¥','gyo':'ã‚®ãƒ§',
      'sha':'ã‚·ãƒ£','shu':'ã‚·ãƒ¥','sho':'ã‚·ãƒ§',
      'ja':'ã‚¸ãƒ£','ju':'ã‚¸ãƒ¥','jo':'ã‚¸ãƒ§',
      'cha':'ãƒãƒ£','chu':'ãƒãƒ¥','cho':'ãƒãƒ§',
      'nya':'ãƒ‹ãƒ£','nyu':'ãƒ‹ãƒ¥','nyo':'ãƒ‹ãƒ§',
      'hya':'ãƒ’ãƒ£','hyu':'ãƒ’ãƒ¥','hyo':'ãƒ’ãƒ§',
      'bya':'ãƒ“ãƒ£','byu':'ãƒ“ãƒ¥','byo':'ãƒ“ãƒ§',
      'pya':'ãƒ”ãƒ£','pyu':'ãƒ”ãƒ¥','pyo':'ãƒ”ãƒ§',
      'mya':'ãƒŸãƒ£','myu':'ãƒŸãƒ¥','myo':'ãƒŸãƒ§',
      'rya':'ãƒªãƒ£','ryu':'ãƒªãƒ¥','ryo':'ãƒªãƒ§',
    };

    function convertRomajiToScript(romaji, scriptType) {
      if (scriptType === 'romaji') return romaji;
      
      const map = scriptType === 'hiragana' ? romajiToHiragana : romajiToKatakana;
      let result = '';
      let i = 0;
      const text = romaji.toLowerCase();
      
      while (i < text.length) {
        if (text[i] === ' ') {
          result += ' ';
          i++;
          continue;
        }
        
        let matched = false;
        if (i + 2 < text.length) {
          const three = text.substr(i, 3);
          if (map[three]) {
            result += map[three];
            i += 3;
            continue;
          }
        }
        
        if (i + 1 < text.length) {
          const two = text.substr(i, 2);
          if (map[two]) {
            result += map[two];
            i += 2;
            continue;
          }
        }
        
        const one = text[i];
        if (map[one]) {
          result += map[one];
          i++;
          continue;
        }
        
        result += text[i];
        i++;
      }
      
      return result;
    }

    // ---------- State ----------
    const state = {
      running: false, score:0, streak:0, done:0, total:10,
      mode:'mc', level:'sen', rate:1.0, timer:0, timerId:null,
      current: null,
      scriptType: 'romaji'
    };

    // ---------- DOM references ----------
    const btnStart = document.getElementById('start');
    const btnSkip = document.getElementById('skip');
    const btnSpeak = document.getElementById('speak');
    const modeSel = document.getElementById('mode');
    const levelSel = document.getElementById('level');
    const limitInput = document.getElementById('limit');
    const timerSel = document.getElementById('timer');
    const rateSlider = document.getElementById('rate');
    const rateVal = document.getElementById('rateVal');
    const promptBox = document.getElementById('prompt');
    const feedback = document.getElementById('feedback');
    const scoreEl = document.getElementById('score');
    const streakEl = document.getElementById('streak');
    const levelLabel = document.getElementById('levelLabel');
    const modeLabel = document.getElementById('modeLabel');
    const progressBar = document.getElementById('progressBar');
    const historyEl = document.getElementById('history');

    // Script type toggle buttons
    const toggleBtns = document.querySelectorAll('.toggle-btn');
    toggleBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        toggleBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.scriptType = btn.dataset.script;
      });
    });

    // ---------- Number â†’ Japanese romaji ----------
    function chunk4(n){
      const s = Math.floor(n).toString();
      const chunks = [];
      for(let i=s.length;i>0;i-=4){
        chunks.unshift(s.slice(Math.max(0,i-4), i));
      }
      return chunks.map(c=>parseInt(c,10)||0);
    }

    function digitRomaji(d){
      return ['','ichi','ni','san','yon','go','roku','nana','hachi','kyuu'][d];
    }

    function thousandsRomaji(th){
      if(!th) return '';
      if(th===1) return 'sen';
      if(th===3) return 'sanzen';
      if(th===8) return 'hassen';
      return digitRomaji(th)+' sen';
    }

    function hundredsRomaji(h){
      if(!h) return '';
      if(h===1) return 'hyaku';
      if(h===3) return 'sanbyaku';
      if(h===6) return 'roppyaku';
      if(h===8) return 'happyaku';
      return digitRomaji(h)+' hyaku';
    }

    function tensRomaji(t){
      if(!t) return '';
      if(t===1) return 'juu';
      return digitRomaji(t)+' juu';
    }

    function onesRomaji(o){
      return digitRomaji(o);
    }

    function fourDigitRomaji(val){
      if(val===0) return '';
      const th = Math.floor(val/1000)%10;
      const h  = Math.floor(val/100)%10;
      const t  = Math.floor(val/10)%10;
      const o  = val%10;
      const parts = [];
      const thStr = thousandsRomaji(th);
      const hStr  = hundredsRomaji(h);
      const tStr  = tensRomaji(t);
      const oStr  = onesRomaji(o);
      if(thStr) parts.push(thStr);
      if(hStr)  parts.push(hStr);
      if(tStr)  parts.push(tStr);
      if(oStr)  parts.push(oStr);
      return parts.join(' ');
    }

    function numberToRomaji(n){
      if(n===0) return 'zero';
      const chunks = chunk4(n);
      const len = chunks.length;
      const names = ['','man','oku','chou'];
      const parts = [];
      for(let i=0; i<len; i++){
        const c = chunks[i];
        if(!c) continue;
        const rom = fourDigitRomaji(c);
        const unit = names[len - i - 1];
        if(unit){
          if(c===1 && (unit==='man'||unit==='oku'||unit==='chou')){
            parts.push('ichi '+unit);
          } else {
            parts.push(rom+' '+unit);
          }
        } else {
          parts.push(rom);
        }
      }
      return parts.join(' ').replace(/\s+/g,' ').trim();
    }

    // ---------- Generators ----------
    function genNumber(level){
      const r = ()=>Math.random();
      if(level==='sen'){
        return Math.floor(r()*99999)+1;
      } else if(level==='man'){
        return Math.floor(r()*(9999999-10000))+10000;
      } else if(level==='oku'){
        return Math.floor(r()*(99999999999 - 100000000))+100000000;
      } else if(level==='chou'){
        return Math.floor(r()*(9999999999999999 - 1000000000000))+1000000000000;
      }
      return 1;
    }

    function buildOptions(correct, level){
      const opts = new Set([correct]);
      let guard=0;
      while(opts.size<4 && guard<50){
        guard++;
        const n = genNumber(level);
        opts.add(numberToRomaji(n));
      }
      const arr=[...opts];
      return shuffle(arr);
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    function formatThousands(n){
      return n.toLocaleString('en-US');
    }

    function updateHud(){
      scoreEl.textContent = state.score;
      streakEl.textContent = state.streak;
      const levelMap={sen:'Lv.1 Sen',man:'Lv.2 Man',oku:'Lv.3 Oku',chou:'Lv.4 Chou'};
      const modeMap={mc:'Äá»c sá»‘',type:'Nháº­p cÃ¡ch Ä‘á»c',listen:'Nghe & gÃµ sá»‘'};
      levelLabel.textContent = levelMap[state.level];
      modeLabel.textContent = modeMap[state.mode];
      progressBar.style.width = `${(state.done/state.total)*100}%`;
    }

    function speakJa(text){
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP';
      u.rate = state.rate;
      u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    function pushHistory(entry){
      const div = document.createElement('div');
      div.innerHTML = entry;
      div.style.marginBottom = '8px';
      div.style.paddingBottom = '8px';
      div.style.borderBottom = '1px solid rgba(255,255,255,.04)';
      historyEl.prepend(div);
    }

    function nextQuestion(){
      if(state.done>=state.total){
        state.running=false;
        promptBox.innerHTML = `<div class="num">ğŸ‰ HoÃ n thÃ nh lÆ°á»£t chÆ¡i!</div><div style="margin-top:10px">Äiá»ƒm: <b>${state.score}</b> Â· Chuá»—i Ä‘Ãºng: <b>${state.streak}</b></div>`;
        feedback.textContent='';
        btnSkip.disabled = true; btnSpeak.disabled=true;
        return;
      }

      btnSkip.disabled=false; btnSpeak.disabled=false;
      state.current = { n: genNumber(state.level) };
      const romaji = numberToRomaji(state.current.n);
      state.current.romaji = romaji;
      state.current.displayText = convertRomajiToScript(romaji, state.scriptType);

      promptBox.innerHTML = '';
      const unit = document.createElement('div'); unit.className='unit';
      const num = document.createElement('div'); num.className='num';

      if(state.mode==='mc' || state.mode==='type'){
        const scriptLabel = {romaji:'Romaji', hiragana:'Hiragana', katakana:'Katakana'}[state.scriptType];
        unit.textContent = `HÃ£y Ä‘á»c sá»‘ sau (${scriptLabel})`;
        num.textContent = formatThousands(state.current.n);
        promptBox.append(unit,num);

        if(state.mode==='mc'){
          const opts = buildOptions(romaji, state.level);
          const box = document.createElement('div'); box.className='options';
          opts.forEach(o=>{
            const displayOpt = convertRomajiToScript(o, state.scriptType);
            const b=document.createElement('button'); 
            b.className='option'; 
            b.textContent=displayOpt;
            b.onclick=()=>checkAnswer(o);
            box.appendChild(b);
          })
          promptBox.appendChild(box);
        }
        if(state.mode==='type'){
          const input = document.createElement('input');
          input.type='text'; 
          input.placeholder=`Nháº­p cÃ¡ch Ä‘á»c (${scriptLabel})`; 
          input.autofocus=true;
          input.style.marginTop = '12px';
          input.style.fontSize = '16px';
          input.onkeydown=(e)=>{ 
            if(e.key==='Enter'){ 
              checkAnswer(input.value.trim()); 
            }
          };
          promptBox.appendChild(input);
        }
      } else if(state.mode==='listen'){
        unit.textContent = 'Nghe phÃ¡t Ã¢m vÃ  nháº­p láº¡i con sá»‘ (báº±ng chá»¯ sá»‘)';
        num.textContent = 'ğŸ”ˆ Nháº¥n nÃºt "PhÃ¡t Ã¢m" Ä‘á»ƒ nghe';
        promptBox.append(unit,num);
        setTimeout(()=> speakJa(state.current.romaji.replace(/\s+/g,' ')), 250);
        const input = document.createElement('input');
        input.type='text'; 
        input.placeholder='Nháº­p sá»‘ (vd: 123456)'; 
        input.autofocus=true;
        input.style.marginTop = '12px';
        input.style.fontSize = '16px';
        input.onkeydown=(e)=>{ if(e.key==='Enter'){ checkAnswer(input.value.trim()); }};
        promptBox.appendChild(input);
      }

      feedback.textContent='';
      startPerQuestionTimer();
      updateHud();
    }

    function startPerQuestionTimer(){
      clearInterval(state.timerId);
      const limit = parseInt(timerSel.value,10);
      if(!limit){ state.timer=0; return; }
      state.timer = limit;
      state.timerId = setInterval(()=>{
        state.timer -= 1;
        if(state.timer<=0){ clearInterval(state.timerId); timeUp(); }
      },1000);
    }

    function timeUp(){
      showResult(false, 'â±ï¸ Háº¿t giá»!');
    }

    function checkAnswer(ans){
      const {n, romaji, displayText} = state.current;
      let correct=false, explain='';
      
      if(state.mode==='mc'){
        correct = normalize(ans) === normalize(romaji);
        explain = `ÄÃ¡p Ã¡n Ä‘Ãºng: <b>${displayText}</b>`;
      } else if(state.mode==='type'){
        const ansConverted = convertUserInputToRomaji(ans);
        correct = normalize(ansConverted) === normalize(romaji);
        explain = `ÄÃ¡p Ã¡n Ä‘Ãºng: <b>${displayText}</b>`;
      } else if(state.mode==='listen'){
        correct = normalizeNumber(ans) === String(n);
        explain = `Sá»‘ Ä‘Ãºng: <b>${formatThousands(n)}</b> Â· CÃ¡ch Ä‘á»c: <span class="kbd">${displayText}</span>`;
      }
      showResult(correct, explain);
    }

    function convertUserInputToRomaji(input) {
      if (/[a-zA-Z]/.test(input)) {
        return input;
      }
      return input;
    }

    function normalize(s){
      return String(s).toLowerCase().replace(/\s+/g,' ').trim();
    }
    function normalizeNumber(s){
      return String(s).replace(/[^0-9]/g,'');
    }

    function showResult(ok, explain){
      clearInterval(state.timerId);
      state.done += 1;
      if(ok){
        state.score += 10; state.streak += 1;
        feedback.innerHTML = `<span class="ok">âœ”ï¸ ChÃ­nh xÃ¡c!</span> ${explain}`;
        pushHistory(`<span style="color:var(--acc-2)">âœ”ï¸</span> <b>${formatThousands(state.current.n)}</b> â†’ <i>${state.current.displayText}</i>`);
      } else {
        state.streak = 0;
        feedback.innerHTML = `<span class="bad">âœ– Sai rá»“i.</span> ${explain}`;
        pushHistory(`<span style="color:var(--danger)">âœ–</span> <b>${formatThousands(state.current.n)}</b> â†’ <i>${state.current.displayText}</i>`);
      }
      updateHud();
      setTimeout(nextQuestion, 800);
    }

    // ---------- Event bindings ----------
    btnStart.addEventListener('click', ()=>{
      state.running = true;
      state.score = 0; state.streak=0; state.done=0;
      state.total = Math.max(5, Math.min(50, parseInt(limitInput.value,10)||10));
      state.mode = modeSel.value; state.level = levelSel.value; state.rate = parseFloat(rateSlider.value)||1.0;
      btnSkip.disabled=false; btnSpeak.disabled=false;
      historyEl.innerHTML = '';
      nextQuestion();
    });

    btnSkip.addEventListener('click', ()=>{
      if(!state.running) return;
      showResult(false, 'ÄÃ£ bá» qua cÃ¢u nÃ y.');
    });

    btnSpeak.addEventListener('click', ()=>{
      if(!state.current) return;
      speakJa(state.current.romaji.replace(/\s+/g,' '));
    });

    modeSel.addEventListener('change',()=>{ state.mode=modeSel.value; updateHud(); });
    levelSel.addEventListener('change',()=>{ state.level=levelSel.value; updateHud(); });

    rateSlider.addEventListener('input', ()=>{
      state.rate = parseFloat(rateSlider.value)||1.0;
      rateVal.textContent = state.rate.toFixed(1)+'Ã—';
    });
  </script>
</body>
</html>
